<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Excel</title>
    <link rel="stylesheet" type="text/css" href="../resources/css/extJs/ext-theme-crisp-all.css"/>

</head>

<!-- GC -->
<style type="text/css">
    .no-icon {
        display: none !important;
    }
</style>
<script type="text/javascript" src="./extJs/ext-all-debug.js"></script>
<script>
    /*

    gridExcel.html.js - convert an Ext 4 grid into an gridExcel.html spreadsheet using nothing but
    javascript and good intentions.

    By: Steve Drucker
    October 26, 2013
    Original Ext 3 Implementation by: Nige "Animal" White?

    Updated: March 19, 2014 to support grouped grids/stores
    Updated: April 3, 2014 to support Internet Explorer

    Contact Info:

    e. sdrucker@figleaf.com
    blog: druckit.wordpress.com
    linkedin: www.linkedin.com/in/uberfig
    git: http://github.com/sdruckerfig
    company: Fig Leaf Software (http://www.figleaf.com / http://training.figleaf.com)

    Invocation:  grid.downloadExcelXml(includeHiddenColumns,title)

*/
    Ext.onReady(function () {
        var Base64 = (function () {
            // Private property
            var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";

            // Private method for UTF-8 encoding

            function utf8Encode(string) {
                string = string.replace(/\r\n/g, "\n");
                var utftext = "";
                for (var n = 0; n < string.length; n++) {
                    var c = string.charCodeAt(n);
                    if (c < 128) {
                        utftext += String.fromCharCode(c);
                    } else if ((c > 127) && (c < 2048)) {
                        utftext += String.fromCharCode((c >> 6) | 192);
                        utftext += String.fromCharCode((c & 63) | 128);
                    } else {
                        utftext += String.fromCharCode((c >> 12) | 224);
                        utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                        utftext += String.fromCharCode((c & 63) | 128);
                    }
                }
                return utftext;
            }

            // Public method for encoding
            return {
                encode: (typeof btoa == 'function') ? function (input) {
                    return btoa(utf8Encode(input));
                } : function (input) {
                    var output = "";
                    var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
                    var i = 0;
                    input = utf8Encode(input);
                    while (i < input.length) {
                        chr1 = input.charCodeAt(i++);
                        chr2 = input.charCodeAt(i++);
                        chr3 = input.charCodeAt(i++);
                        enc1 = chr1 >> 2;
                        enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
                        enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
                        enc4 = chr3 & 63;
                        if (isNaN(chr2)) {
                            enc3 = enc4 = 64;
                        } else if (isNaN(chr3)) {
                            enc4 = 64;
                        }
                        output = output +
                            keyStr.charAt(enc1) + keyStr.charAt(enc2) +
                            keyStr.charAt(enc3) + keyStr.charAt(enc4);
                    }
                    return output;
                }
            };
        })();
        Ext.define('Hr.view.override.Grid', {
            override: 'Ext.grid.GridPanel',
            requires: 'Ext.form.action.StandardSubmit',

            /*
                Kick off process
            */

            downloadExcelXml: function (includeHidden, title) {

                if (!title) title = this.excelName;
                var vExportContent = this.getExcelXml(includeHidden, title);

                var location = 'data:application/vnd.ms-excel;base64,' + Base64.encode(vExportContent);

                /*
                  dynamically create and anchor tag to force download with suggested filename
                  note: download attribute is Google Chrome specific
                */

                if (Ext.isChrome) {
                    var gridEl = this.getEl();

                    var el = Ext.DomHelper.append(gridEl, {
                        tag: "a",
                        download: title + "-" + Ext.Date.format(new Date(), 'Y-m-d Hi') + '.xls',
                        href: location
                    });

                    el.click();

                    Ext.fly(el).destroy();

                } else {

                    var form = this.down('form#uploadForm');
                    if (form) {
                        form.destroy();
                    }
                    form = this.add({
                        xtype: 'form',
                        itemId: 'uploadForm',
                        hidden: true,
                        standardSubmit: true,
                        url: 'http://webapps.figleaf.com/dataservices/Excel.cfc?method=echo&mimetype=application/vnd.ms-excel&filename=' + escape(title + ".xls"),
                        items: [{
                            xtype: 'hiddenfield',
                            name: 'data',
                            value: vExportContent
                        }]
                    });

                    form.getForm().submit();

                }
            },

            /*

                Welcome to XML Hell
                See: http://msdn.microsoft.com/en-us/library/office/aa140066(v=office.10).aspx
                for more details

            */
            getExcelXml: function (includeHidden, title) {

                var theTitle = title || this.title;

                var worksheet = this.createWorksheet(includeHidden, theTitle);
                var totalWidth = this.columnManager.columns.length;

                return ''.concat(
                    '<?xml version="1.0"?>',
                    '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">',
                    '<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office"><Title>' + theTitle + '</Title></DocumentProperties>',
                    '<OfficeDocumentSettings xmlns="urn:schemas-microsoft-com:office:office"><AllowPNG/></OfficeDocumentSettings>',
                    '<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">',
                    '<WindowHeight>' + worksheet.height + '</WindowHeight>',
                    '<WindowWidth>' + worksheet.width + '</WindowWidth>',
                    '<ProtectStructure>False</ProtectStructure>',
                    '<ProtectWindows>False</ProtectWindows>',
                    '</ExcelWorkbook>',

                    '<Styles>',

                    '<Style ss:ID="Default" ss:Name="Normal">',
                    '<Alignment ss:Vertical="Bottom"/>',
                    '<Borders/>',
                    '<Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="12" ss:Color="#000000"/>',
                    '<Interior/>',
                    '<NumberFormat/>',
                    '<Protection/>',
                    '</Style>',

                    '<Style ss:ID="title">',
                    '<Borders />',
                    '<Font ss:Bold="1" ss:Size="18" />',
                    '<Alignment ss:Horizontal="Center" ss:Vertical="Center" ss:WrapText="1" />',
                    '<NumberFormat ss:Format="@" />',
                    '</Style>',

                    '<Style ss:ID="headercell">',
                    '<Font ss:Bold="1" ss:Size="10" />',
                    '<Alignment ss:Horizontal="Center" ss:WrapText="1" />',
                    '<Interior ss:Color="#A3C9F1" ss:Pattern="Solid" />',
                    '</Style>',


                    '<Style ss:ID="even">',
                    '<Interior ss:Color="#CCFFFF" ss:Pattern="Solid" />',
                    '</Style>',


                    '<Style ss:ID="evendate" ss:Parent="even">',
                    '<NumberFormat ss:Format="yyyy-mm-dd" />',
                    '</Style>',


                    '<Style ss:ID="evenint" ss:Parent="even">',
                    '<Numberformat ss:Format="0" />',
                    '</Style>',

                    '<Style ss:ID="evenfloat" ss:Parent="even">',
                    '<Numberformat ss:Format="0.00" />',
                    '</Style>',

                    '<Style ss:ID="odd">',
                    '<Interior ss:Color="#CCCCFF" ss:Pattern="Solid" />',
                    '</Style>',

                    '<Style ss:ID="groupSeparator">',
                    '<Interior ss:Color="#D3D3D3" ss:Pattern="Solid" />',
                    '</Style>',

                    '<Style ss:ID="odddate" ss:Parent="odd">',
                    '<NumberFormat ss:Format="yyyy-mm-dd" />',
                    '</Style>',

                    '<Style ss:ID="oddint" ss:Parent="odd">',
                    '<NumberFormat Format="0" />',
                    '</Style>',

                    '<Style ss:ID="oddfloat" ss:Parent="odd">',
                    '<NumberFormat Format="0.00" />',
                    '</Style>',


                    '</Styles>',
                    worksheet.xml,
                    '</Workbook>'
                );
            },

            /*

                Support function to return field info from store based on fieldname

            */

            getModelField: function (fieldName) {

                var fields = this.store.model.getFields();
                for (var i = 0; i < fields.length; i++) {
                    if (fields[i].name === fieldName) {
                        return fields[i];
                    }
                }
            },

            /*

                Convert store into gridExcel.html Worksheet

            */
            generateEmptyGroupRow: function (dataIndex, value, cellTypes, includeHidden) {


                var cm = this.columnManager.columns;
                var colCount = cm.length;
                var rowTpl = '<Row ss:AutoFitHeight="0"><Cell ss:StyleID="groupSeparator" ss:MergeAcross="{0}"><Data ss:Type="String"><html:b>{1}</html:b></Data></Cell></Row>';
                var visibleCols = 0;

                // rowXml += '<Cell ss:StyleID="groupSeparator">'

                for (var j = 0; j < colCount; j++) {
                    if (cm[j].xtype != 'actioncolumn' && (cm[j].dataIndex != '') && (includeHidden || !cm[j].hidden)) {
                        // rowXml += '<Cell ss:StyleID="groupSeparator"/>';
                        visibleCols++;
                    }
                }

                // rowXml += "</Row>";

                return Ext.String.format(rowTpl, visibleCols - 1, value);
            },


            createWorksheet: function (includeHidden, theTitle) {
                // Calculate cell data types and extra class names which affect formatting
                var cellType = [];
                var cellTypeClass = [];
                console.log(this);
                var cm = this.columnManager.columns;

                var totalWidthInPixels = 0;
                var colXml = '';
                var headerXml = '';
                var visibleColumnCountReduction = 0;
                var colCount = cm.length;
                for (var i = 0; i < colCount; i++) {
                    if (cm[i].xtype != 'actioncolumn' && (cm[i].dataIndex != '') && (includeHidden || !cm[i].hidden)) {
                        var w = cm[i].getEl().getWidth();
                        totalWidthInPixels += w;

                        if (cm[i].text === "") {
                            cellType.push("None");
                            cellTypeClass.push("");
                            ++visibleColumnCountReduction;
                        } else {
                            colXml += '<Column ss:AutoFitWidth="1" ss:Width="' + w + '" />';
                            headerXml += '<Cell ss:StyleID="headercell">' +
                                '<Data ss:Type="String">' + cm[i].text + '</Data>' +
                                '<NamedCell ss:Name="Print_Titles"></NamedCell></Cell>';


                            var fld = this.getModelField(cm[i].dataIndex);
                            switch (fld.type.type) {
                                case "int":
                                    cellType.push("Number");
                                    cellTypeClass.push("int");
                                    break;
                                case "float":
                                    cellType.push("Number");
                                    cellTypeClass.push("float");
                                    break;

                                case "bool":

                                case "boolean":
                                    cellType.push("String");
                                    cellTypeClass.push("");
                                    break;
                                case "date":
                                    cellType.push("DateTime");
                                    cellTypeClass.push("date");
                                    break;
                                default:
                                    cellType.push("String");
                                    cellTypeClass.push("");
                                    break;
                            }
                        }
                    }
                }
                var visibleColumnCount = cellType.length - visibleColumnCountReduction;

                var result = {
                    height: 9000,
                    width: Math.floor(totalWidthInPixels * 30) + 50
                };

                // Generate worksheet header details.

                // determine number of rows
                var numGridRows = this.store.getCount() + 2;
                if (!Ext.isEmpty(this.store.groupField) || (this.store.grouper != null && this.store.grouper.items.length > 0)) {
                    numGridRows = numGridRows + this.store.getGroups().length;
                }

                // create header for worksheet
                var t = ''.concat(
                    '<Worksheet ss:Name="' + theTitle + '">',

                    '<Names>',
                    '<NamedRange ss:Name="Print_Titles" ss:RefersTo="=\'' + theTitle + '\'!R1:R2">',
                    '</NamedRange></Names>',

                    '<Table ss:ExpandedColumnCount="' + (visibleColumnCount + 2),
                    '" ss:ExpandedRowCount="' + numGridRows + '" x:FullColumns="1" x:FullRows="1" ss:DefaultColumnWidth="65" ss:DefaultRowHeight="15">',
                    colXml,
                    '<Row ss:Height="38">',
                    '<Cell ss:MergeAcross="' + (visibleColumnCount - 1) + '" ss:StyleID="title">',
                    '<Data ss:Type="String" xmlns:html="http://www.w3.org/TR/REC-html40">',
                    '<html:b>' + theTitle + '</html:b></Data><NamedCell ss:Name="Print_Titles">',
                    '</NamedCell></Cell>',
                    '</Row>',
                    '<Row ss:AutoFitHeight="1">',
                    headerXml +
                    '</Row>'
                );

                console.log(t);
                // Generate the data rows from the data in the Store
                var groupVal = "";
                var groupField = "";
                if (this.store.grouper && this.store.grouper.keys.length > 0) {
                    groupField = this.store.groupers.keys[0];
                }
                for (var i = 0, it = this.store.data.items, l = it.length; i < l; i++) {

                    if (!Ext.isEmpty(groupField)) {
                        if (groupVal != this.store.getAt(i).get(groupField)) {
                            groupVal = this.store.getAt(i).get(groupField);
                            t += this.generateEmptyGroupRow(groupField, groupVal, cellType, includeHidden);
                        }
                    }
                    t += '<Row>';
                    var cellClass = (i & 1) ? 'odd' : 'even';
                    r = it[i].data;
                    var k = 0;
                    for (var j = 0; j < colCount; j++) {
                        if (cm[j].xtype != 'actioncolumn' && (cm[j].dataIndex != '') && (includeHidden || !cm[j].hidden)) {
                            var v = r[cm[j].dataIndex];
                            if (cellType[k] !== "None") {
                                t += '<Cell ss:StyleID="' + cellClass + cellTypeClass[k] + '"><Data ss:Type="' + cellType[k] + '">';
                                if (cellType[k] == 'DateTime') {
                                    t += Ext.Date.format(v, 'Y-m-d');
                                } else {
                                    t += v;
                                }
                                t += '</Data></Cell>';
                            }
                            k++;
                        }
                    }
                    t += '</Row>';
                }

                result.xml = t.concat(
                    '</Table>',
                    '<WorksheetOptions xmlns="urn:schemas-microsoft-com:office:excel">',
                    '<PageLayoutZoom>0</PageLayoutZoom>',
                    '<Selected/>',
                    '<Panes>',
                    '<Pane>',
                    '<Number>3</Number>',
                    '<ActiveRow>2</ActiveRow>',
                    '</Pane>',
                    '</Panes>',
                    '<ProtectObjects>False</ProtectObjects>',
                    '<ProtectScenarios>False</ProtectScenarios>',
                    '</WorksheetOptions>',
                    '</Worksheet>'
                );
                return result;
            }
        });


        Ext.application({
            name: 'Fiddle',

            launch: function () {
                // Ext.Msg.alert('Grid to gridExcel.html Example', 'Welcome!');
                Ext.create('Ext.data.Store', {
                    storeId: 'simpsonsStore',
                    fields: ['houid', 'houseTag', 'address', 'hscode',
                        'streetTs', 'forecastmarkTs', 'regionCodeTs', 'cno', 'oldcfzh',
                        'sno', 'saddno', 'natuno', 'uno', 'fno',
                        'rno', 'plUsageTs', 'houUsageTs', 'houCharactorTs', 'structTs',
                        'inarea', 'outarea', 'oldjzmj', 'generateTypeTs', 'licenseid'],
                    data: {
                        'items': [{
                            'houid': 1005,
                            'houseTag': 'OR1',
                            'address': '顺庆区模范街2号南充大都会1幢1层136号',
                            'hscode': '',
                            'streetTs': '模范街',
                            'forecastmarkTs': "实测",
                            'regionCodeTs': "顺庆区",
                            'cno': "0796619",
                            'oldcfzh': "",
                            'sno': "",
                            'saddno': "2号",
                            'natuno': "南充大都会",
                            'uno': 1,
                            'fno': '',
                            'rno': '',
                            'plUsageTs': '136',
                            'houUsageTs': "非住宅",
                            'houCharactorTs': '其他结构',
                            'structTs': '其他结构',
                            'inarea': 3.36,
                            'outarea': 3.13,
                            'oldjzmj': 6.48,
                            'generateTypeTs': '系统迁移',
                            'licenseid': ''
                        }
                        ]
                    },
                    proxy: {
                        type: 'memory',
                        reader: {
                            type: 'json',
                            rootProperty: 'items'
                        }
                    },
                });

                Ext.create('Ext.grid.Panel', {
                    store: Ext.data.StoreManager.lookup('simpsonsStore'),
                    excelName: '楼栋房屋信息',
                    columns: [
                        {text: '房屋唯一号', dataIndex: 'houid',},
                        {text: '房屋标识', dataIndex: 'houseTag'},
                        {text: '房屋地址', dataIndex: 'address'},
                        {text: '房屋编码', dataIndex: 'hscode'},
                        {text: '街道', dataIndex: 'streetTs'},
                        {text: '预/实测', dataIndex: 'forecastmarkTs'},
                        {text: '所在区', dataIndex: 'regionCodeTs'},
                        {text: '权证号', dataIndex: 'cno'},
                        {text: '限制编号', dataIndex: 'oldcfzh'},
                        {text: '门牌号', dataIndex: 'sno'},
                        {text: '附号', dataIndex: 'saddno'},
                        {text: '幢号', dataIndex: 'natuno'},
                        {text: '单元', dataIndex: 'uno'},
                        {text: '楼层', dataIndex: 'fno'},
                        {text: '房号', dataIndex: 'rno'},
                        {text: '规划用途', dataIndex: 'plUsageTs'},
                        // {text: '房屋用途', dataIndex: 'houUsageTs'},
                        // {text: '房屋性质', dataIndex: 'houCharactorTs'},
                        {text: '结构', dataIndex: 'structTs'},
                        {text: '套内面积', dataIndex: 'inarea'},
                        {text: '公摊面积', dataIndex: 'outarea'},
                        {text: '建筑面积', dataIndex: 'oldjzmj'},
                        {text: '房屋来源', dataIndex: 'generateTypeTs'},
                        {text: '预售证号', dataIndex: 'licenseid'}],
                    height: 200,
                    width: 1500,
                    dockedItems: [{
                        xtype: 'toolbar',
                        docked: 'bottom',
                        items: [{
                            xtype: 'button',
                            flex: 1,
                            text: 'Download to Excel',
                            handler: function (b, e) {
                                b.up('grid').downloadExcelXml();
                            }
                        }]
                    }

                    ],
                    renderTo: Ext.getBody()
                });
            }
        })
    });
    // or replace all text with a URL
</script>
<body>

</body>
</html>